<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Demandas - Gabinete Digital</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    <!-- Prop-Types (Required by Recharts UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- Recharts -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.2/umd/Recharts.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Export Libraries (PDF & Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-item-active {
            background: #e2e8f0;
            color: #2563eb;
            font-weight: 600;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                    }
                }
            }
        }
    </script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const {
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
            PieChart, Pie, Cell, Legend, LineChart, Line
        } = Recharts;

        // --- Supabase Config ---
        const SUPABASE_URL = "https://wopteukjywtkowhgdmbf.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_-8VbUXEcKC9DKPpzt11AWQ_jF23FAgD";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Mock Data / Initial State ---
        const INITIAL_DEMANDAS = [
            { id: 1, cidadao: "João Silva", bairro: "Centro", tipo: "Iluminação Pública", status: "Concluída", urgencia: "Alta", registro: "2024-01-15", descricao: "Lâmpada queimada na Rua XV de Novembro." },
            { id: 2, cidadao: "Maria Oliveira", bairro: "Vila Nova", tipo: "Saúde", status: "Em análise", urgencia: "Média", registro: "2024-02-01", descricao: "Falta de medicamentos no posto de saúde." },
            { id: 3, cidadao: "Pedro Santos", bairro: "Jardim América", tipo: "Buracos na Via", status: "Encaminhada à prefeitura", urgencia: "Alta", registro: "2024-02-03", descricao: "Buraco enorme na Av. Principal." },
        ];

        const STATUS_OPTIONS = [
            "Recebida", "Em análise", "Encaminhada à prefeitura", "Em execução", "Concluída", "Arquivada", "Excluídas"
        ];

        const TIPOS_OPTIONS = [
            "Iluminação Pública", "Buracos na Via", "Coleta de Lixo", "Saúde", "Educação", "Segurança", "Transporte", "Outros"
        ];



        // --- Icons Adapter ---
        const Icon = ({ name, className = "", size = 20 }) => {
            const ref = React.useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    const iconNode = document.createElement('i');
                    iconNode.setAttribute('data-lucide', name);
                    iconNode.className = className;
                    iconNode.style.width = `${size}px`;
                    iconNode.style.height = `${size}px`;

                    ref.current.innerHTML = '';
                    ref.current.appendChild(iconNode);
                    window.lucide.createIcons({
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, className, size]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- Components ---

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-100 text-blue-700",
                green: "bg-green-100 text-green-700",
                yellow: "bg-yellow-100 text-yellow-700",
                red: "bg-red-100 text-red-700",
                gray: "bg-gray-100 text-gray-700",
                purple: "bg-purple-100 text-purple-700"
            };
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[color] || colors.blue}`}>
                    {children}
                </span>
            );
        };

        const getStatusColor = (status) => {
            switch (status) {
                case "Concluída": return "green";
                case "Em execução": return "blue";
                case "Em análise": return "yellow";
                case "Recebida": return "gray";
                case "Excluída/Cancelada": return "red";
                case "Excluídas": return "red";
                case "Encaminhada à prefeitura": return "purple";
                case "Arquivada": return "gray";
                default: return "blue";
            }
        };

        const getUrgenciaColor = (urg) => {
            switch (urg) {
                case "Crítica": return "red";
                case "Alta": return "yellow";
                case "Média": return "blue";
                default: return "gray";
            }
        };

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bg = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';

            return (
                <div className={`fixed bottom-4 right-4 ${bg} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-bounce-in z-50`}>
                    <Icon name={icon} />
                    <span className="font-semibold">{message}</span>
                    <button onClick={onClose} className="ml-2 hover:bg-white/20 p-1 rounded-full">
                        <Icon name="x" size={16} />
                    </button>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [admin, setAdmin] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [demandas, setDemandas] = useState([]);
            const [bairros, setBairros] = useState([]);
            const [loading, setLoading] = useState(true);
            const [authLoading, setAuthLoading] = useState(true);

            // Filtros e Paginação
            const [searchTerm, setSearchTerm] = useState('');
            const [filterBairro, setFilterBairro] = useState('Todos');
            const [filterStatus, setFilterStatus] = useState('Todos');
            const [page, setPage] = useState(0);
            const [totalCount, setTotalCount] = useState(0);
            const PAGE_SIZE = 10;

            const [selectedDemanda, setSelectedDemanda] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [toast, setToast] = useState(null);

            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };

            // Configuração: E-mails autorizados a acessar o painel
            const ADMIN_EMAILS = ['cleberfdosreis@gmail.com']; // ADICIONE OS E-MAILS AUTORIZADOS AQUI

            const isAuthorized = (user) => {
                if (!user) return false;
                return ADMIN_EMAILS.includes(user.email);
            };

            // Verificação de Autenticação
            useEffect(() => {
                const checkUser = async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    const user = session?.user || null;

                    if (user && !isAuthorized(user)) {
                        await supabase.auth.signOut();
                        setAdmin(null);
                        showToast('Acesso negado: E-mail não autorizado.', 'error');
                    } else {
                        setAdmin(user);
                    }
                    setAuthLoading(false);
                };
                checkUser();

                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event, session) => {
                    const user = session?.user || null;
                    if (user && !isAuthorized(user)) {
                        await supabase.auth.signOut();
                        setAdmin(null);
                        showToast('E-mail não autorizado para este painel.', 'error');
                    } else {
                        setAdmin(user);
                    }
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const formData = new FormData(e.target);
                const email = formData.get('email');
                const password = formData.get('password');

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;

                    if (!isAuthorized(data.user)) {
                        await supabase.auth.signOut();
                        throw new Error('Este e-mail não possui permissão de acesso ao painel.');
                    }

                    showToast('Bem-vindo, Vereador!');
                } catch (err) {
                    showToast(err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                await supabase.auth.signOut();
                showToast('Logoff realizado.');
            };

            const handleUpdatePassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                const formData = new FormData(e.target);
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');

                if (password !== confirmPassword) {
                    showToast('As senhas não coincidem.', 'error');
                    setLoading(false);
                    return;
                }

                try {
                    const { error } = await supabase.auth.updateUser({ password });
                    if (error) throw error;
                    showToast('Senha alterada com sucesso!');
                    setActiveTab('dashboard');
                } catch (err) {
                    showToast(err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleExport = async (format) => {
                setLoading(true);
                try {
                    // Buscar TODAS as demandas com os filtros atuais (ignorando paginação)
                    let query = supabase.from('demandas').select('*');

                    if (filterStatus === 'Excluídas') {
                        query = query.not('deleted_at', 'is', null);
                    } else {
                        query = query.is('deleted_at', null);
                        if (filterStatus !== 'Todos') query = query.eq('status', filterStatus);
                    }

                    const { data, error } = await query.order('id', { ascending: false });
                    if (error) throw error;

                    if (format === 'excel') {
                        exportToExcel(data);
                    } else if (format === 'pdf') {
                        exportToPDF(data);
                    }
                } catch (err) {
                    showToast(`Erro na exportação: ${err.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const exportToExcel = (data) => {
                const worksheet = XLSX.utils.json_to_sheet(data.map(d => ({
                    'Protocolo': d.id,
                    'Cidadão': d.cidadao,
                    'Bairro': d.bairro,
                    'Endereço': d.endereco || '',
                    'Tipo': d.tipo,
                    'Urgência': d.urgencia,
                    'Status': d.deleted_at ? 'Excluída' : d.status,
                    'Registro': d.registro,
                    'Motivo Exclusão': d.motivo_exclusao || '',
                    'Descrição': d.descricao
                })));
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Demandas");
                XLSX.writeFile(workbook, `Relatorio_Demandas_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Relatório Excel gerado!');
            };

            const exportToPDF = (data) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');

                doc.text("Relatório de Demandas - Gabinete Digital", 14, 15);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 22);

                const tableColumn = ["ID", "Cidadão", "Bairro", "Tipo", "Urgência", "Status", "Data"];
                const tableRows = data.map(d => [
                    d.id, d.cidadao, d.bairro, d.tipo, d.urgencia, d.status, d.registro
                ]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillStyle: '#2563eb' }
                });

                doc.save(`Relatorio_Demandas_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('Relatório PDF gerado!');
            };

            // Debounce searchTerm
            const [debouncedSearchTerm, setDebouncedSearchTerm] = useState(searchTerm);
            useEffect(() => {
                const timer = setTimeout(() => setDebouncedSearchTerm(searchTerm), 500);
                return () => clearTimeout(timer);
            }, [searchTerm]);

            // Fetch Data
            const fetchDemandas = async () => {
                if (!admin) return;
                setLoading(true);
                try {
                    let query = supabase.from('demandas').select('*', { count: 'exact' });

                    if (filterStatus === 'Excluídas') {
                        query = query.not('deleted_at', 'is', null);
                    } else {
                        query = query.is('deleted_at', null);
                        if (filterStatus !== 'Todos') query = query.eq('status', filterStatus);
                    }

                    if (debouncedSearchTerm) {
                        query = query.or(`cidadao.ilike.%${debouncedSearchTerm}%,descricao.ilike.%${debouncedSearchTerm}%`);
                    }

                    const from = page * PAGE_SIZE;
                    const to = from + PAGE_SIZE - 1;

                    const { data, count, error } = await query.order('id', { ascending: false }).range(from, to);
                    if (error) throw error;
                    setDemandas(data || []);
                    setTotalCount(count || 0);
                } catch (err) {
                    showToast(`Erro ao carregar: ${err.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Fetch Bairros
            useEffect(() => {
                if (!admin) return;
                const fetchBairros = async () => {
                    const { data, error } = await supabase
                        .from('bairros')
                        .select('nome')
                        .order('nome', { ascending: true });
                    if (!error && data) setBairros(data.map(b => b.nome));
                };
                fetchBairros();
            }, [admin]);

            useEffect(() => {
                if (admin) fetchDemandas();
            }, [admin, page, debouncedSearchTerm, filterBairro, filterStatus]);

            useEffect(() => setPage(0), [debouncedSearchTerm, filterBairro, filterStatus]);

            // Dashboard Stats
            const [dashboardStats, setDashboardStats] = useState({
                total: 0, pendentes: 0, concluidas: 0, bairroChart: [], statusChart: []
            });

            useEffect(() => {
                if (activeTab === 'dashboard' && admin) {
                    const fetchStats = async () => {
                        const { data, error } = await supabase.from('demandas').select('status, bairro').is('deleted_at', null);
                        if (error || !data) return;

                        const byBairro = data.reduce((acc, d) => {
                            acc[d.bairro] = (acc[d.bairro] || 0) + 1;
                            return acc;
                        }, {});
                        const chartData = Object.keys(byBairro).map(name => ({ name, value: byBairro[name] }));

                        const byStatus = data.reduce((acc, d) => {
                            acc[d.status] = (acc[d.status] || 0) + 1;
                            return acc;
                        }, {});
                        const statusChartData = Object.keys(byStatus).map(name => ({ name, total: byStatus[name] }));

                        setDashboardStats({
                            total: data.length,
                            pendentes: data.filter(d => d.status !== 'Concluída' && d.status !== 'Arquivada').length,
                            concluidas: data.filter(d => d.status === 'Concluída').length,
                            bairroChart: chartData,
                            statusChart: statusChartData
                        });
                    };
                    fetchStats();
                }
            }, [activeTab, admin]);

            const handleAddDemanda = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newDemanda = {
                    cidadao: formData.get('cidadao'),
                    bairro: formData.get('bairro'),
                    endereco: formData.get('endereco'),
                    tipo: formData.get('tipo'),
                    urgencia: formData.get('urgencia'),
                    registro: new Date().toISOString().split('T')[0],
                    status: "Recebida",
                    descricao: formData.get('descricao')
                };

                const { data, error } = await supabase.from('demandas').insert([newDemanda]).select();
                if (error) {
                    showToast('Erro ao salvar no banco de dados.', 'error');
                } else if (data) {
                    setDemandas([data[0], ...demandas]);
                    setActiveTab('list');
                    showToast('Demanda registrada com sucesso!');
                    e.target.reset();
                }
            };

            const updateStatus = async (id, newStatus) => {
                const { error } = await supabase.from('demandas').update({ status: newStatus }).eq('id', id);
                if (error) {
                    showToast('Erro ao atualizar status.', 'error');
                } else {
                    showToast('Status atualizado com sucesso!');
                    setDemandas(demandas.map(d => d.id === id ? { ...d, status: newStatus } : d));
                    if (selectedDemanda && selectedDemanda.id === id) {
                        setSelectedDemanda({ ...selectedDemanda, status: newStatus });
                    }
                }
            };

            const deleteDemanda = async (id) => {
                const motivo = prompt('Por favor, informe o motivo da exclusão para registro e aviso ao cidadão:');
                if (motivo === null) return; // Cancelou o prompt
                if (!motivo.trim()) {
                    showToast('O motivo é obrigatório para excluir.', 'error');
                    return;
                }

                const { error } = await supabase.from('demandas')
                    .update({
                        deleted_at: new Date().toISOString(),
                        motivo_exclusao: motivo.trim(),
                        status: 'Excluída/Cancelada'
                    })
                    .eq('id', id);

                if (error) {
                    showToast('Erro ao excluir demanda.', 'error');
                } else {
                    showToast('Demanda arquivada com sucesso!');
                    setDemandas(demandas.filter(d => d.id !== id));
                    setTotalCount(prev => prev - 1);
                    if (selectedDemanda && selectedDemanda.id === id) setSelectedDemanda(null);
                }
            };

            const migrateLocalData = async () => {
                const saved = localStorage.getItem('demandas_vereador');
                if (!saved) return;
                const localData = JSON.parse(saved);
                if (!localData || localData.length === 0) return;

                if (confirm(`Sincronizar ${localData.length} registros locais?`)) {
                    setLoading(true);
                    try {
                        const toInsert = localData.map(({ id, ...rest }) => rest);
                        const { error } = await supabase.from('demandas').insert(toInsert);
                        if (error) throw error;
                        localStorage.removeItem('demandas_vereador');
                        showToast('Dados sincronizados!');
                        fetchDemandas();
                    } catch (err) {
                        showToast('Erro ao sincronizar.', 'error');
                    } finally {
                        setLoading(false);
                    }
                }
            };

            if (authLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    </div>
                );
            }

            if (!admin) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                        <div className="glass p-8 md:p-12 rounded-3xl shadow-xl border-t-8 border-t-primary max-w-md w-full animate-bounce-in">
                            <div className="flex flex-col items-center mb-8">
                                <div className="w-16 h-16 bg-primary text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary/20 mb-4">
                                    <Icon name="check-circle-2" size={32} />
                                </div>
                                <h1 className="text-2xl font-bold text-slate-800">Painel Administrativo</h1>
                                <p className="text-slate-500">Gabinete Digital - Login do Gestor</p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-5">
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-slate-700">E-mail</label>
                                    <input required name="email" type="email" className="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="adm@exemplo.com" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-slate-700">Senha</label>
                                    <input required name="password" type="password" className="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="••••••••" />
                                </div>
                                <button disabled={loading} className="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.01] active:scale-95 transition-all">
                                    {loading ? 'Entrando...' : 'Acessar Painel'}
                                </button>
                            </form>
                            <p className="mt-8 text-center text-xs text-slate-400 font-sans">
                                Acesso restrito ao gabinete do vereador.
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen bg-slate-50 relative">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {/* Mobile Overlay */}
                    {isSidebarOpen && (
                        <div
                            className="fixed inset-0 bg-slate-900/40 z-40 md:hidden backdrop-blur-sm transition-opacity"
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 glass border-r bg-white md:bg-white/50 transition-transform duration-300 ease-in-out md:translate-x-0 md:static ${isSidebarOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                        <div className="p-6 flex items-center justify-between">
                            <h1 className="text-xl font-bold text-primary flex items-center gap-2">
                                <Icon name="check-circle-2" /> Gabinete Digital
                            </h1>
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg">
                                <Icon name="x" size={20} />
                            </button>
                        </div>
                        <nav className="mt-4 px-4 space-y-1">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                                { id: 'list', label: 'Demandas', icon: 'clipboard-list' },
                                { id: 'add', label: 'Nova Solicitação', icon: 'plus-circle' },
                                { id: 'password', label: 'Redefinir Senha', icon: 'key' }
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => {
                                        setActiveTab(item.id);
                                        setIsSidebarOpen(false);
                                    }}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === item.id ? 'sidebar-item-active shadow-sm' : 'text-slate-600 hover:bg-slate-100'
                                        }`}
                                >
                                    <Icon name={item.icon} size={18} />
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="absolute bottom-8 left-4 right-4 space-y-3">
                            {localStorage.getItem('demandas_vereador') && JSON.parse(localStorage.getItem('demandas_vereador')).length > 0 && (
                                <button
                                    onClick={migrateLocalData}
                                    className="w-full flex items-center gap-2 px-3 py-2 rounded-lg bg-yellow-50 text-yellow-700 text-xs font-bold border border-yellow-200 hover:bg-yellow-100 transition-all font-sans"
                                >
                                    <Icon name="refresh-cw" size={14} /> Sincronizar Dados Locais
                                </button>
                            )}

                            <div className="p-4 rounded-2xl bg-slate-50 border border-slate-100">
                                <p className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Administrador</p>
                                <p className="text-xs font-bold text-slate-700 truncate mb-3">{admin?.email}</p>
                                <button
                                    onClick={handleLogout}
                                    className="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-white text-danger text-xs font-bold border border-danger/20 hover:bg-danger/5 transition-all"
                                >
                                    <Icon name="log-out" size={14} /> Sair do Painel
                                </button>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto">
                        <header className="h-20 glass sticky top-0 z-10 flex items-center justify-between px-4 md:px-8 bg-white/50 border-b">
                            <div className="flex items-center gap-3 md:gap-4">
                                <button
                                    onClick={() => setIsSidebarOpen(true)}
                                    className="md:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-xl transition-colors"
                                    aria-label="Abrir menu"
                                >
                                    <Icon name="menu" size={24} />
                                </button>
                                <h2 className="text-lg font-semibold text-slate-800 capitalize truncate">
                                    {activeTab === 'dashboard' ? 'Visão Geral' : activeTab === 'list' ? 'Gestão de Demandas' : 'Novo Registro'}
                                </h2>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-right hidden sm:block">
                                    <p className="text-xs text-slate-500">{new Date().toLocaleDateString('pt-BR', { dateStyle: 'full' })}</p>
                                </div>
                                <div className="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold">
                                    V
                                </div>
                            </div>
                        </header>

                        <div className="p-8 max-w-7xl mx-auto">
                            {loading && (
                                <div className="flex justify-center items-center py-20">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                                </div>
                            )}

                            {!loading && (
                                <>
                                    {/* Dashboard View */}
                                    {activeTab === 'dashboard' && (
                                        <div className="space-y-8">
                                            {/* Stats Grid */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                {[
                                                    { label: 'Total de Demandas', value: dashboardStats.total, icon: 'list', color: 'text-blue-600', bColor: 'bg-blue-50' },
                                                    { label: 'Em Aberto', value: dashboardStats.pendentes, icon: 'clock', color: 'text-yellow-600', bColor: 'bg-yellow-50' },
                                                    { label: 'Resolvidas', value: dashboardStats.concluidas, icon: 'check-circle', color: 'text-green-600', bColor: 'bg-green-50' }
                                                ].map((s, i) => (
                                                    <div key={i} className="glass p-6 rounded-2xl flex items-center gap-4 bg-white/30">
                                                        <div className={`${s.bColor} ${s.color} p-4 rounded-xl`}>
                                                            <Icon name={s.icon} />
                                                        </div>
                                                        <div>
                                                            <p className="text-sm text-slate-500 font-medium">{s.label}</p>
                                                            <p className="text-2xl font-bold text-slate-800">{s.value}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Charts Section */}
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                                <div className="glass p-8 rounded-2xl bg-white/30">
                                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2">
                                                        <Icon name="map" className="text-primary" /> Demandas por Bairro
                                                    </h3>
                                                    <div className="h-64">
                                                        <ResponsiveContainer width="100%" height="100%">
                                                            <BarChart data={dashboardStats.bairroChart}>
                                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                                <XAxis dataKey="name" fontSize={12} axisLine={false} tickLine={false} />
                                                                <YAxis fontSize={12} axisLine={false} tickLine={false} />
                                                                <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }} />
                                                                <Bar dataKey="value" fill="#2563eb" radius={[4, 4, 0, 0]} barSize={40} />
                                                            </BarChart>
                                                        </ResponsiveContainer>
                                                    </div>
                                                </div>

                                                <div className="glass p-8 rounded-2xl bg-white/30">
                                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2">
                                                        <Icon name="activity" className="text-primary" /> Evolução por Status
                                                    </h3>
                                                    <div className="h-64">
                                                        <ResponsiveContainer width="100%" height="100%">
                                                            <PieChart>
                                                                <Pie
                                                                    data={dashboardStats.statusChart}
                                                                    innerRadius={60}
                                                                    outerRadius={80}
                                                                    paddingAngle={5}
                                                                    dataKey="total"
                                                                >
                                                                    {dashboardStats.statusChart.map((entry, index) => (
                                                                        <Cell key={`cell-${index}`} fill={['#2563eb', '#10b981', '#f59e0b', '#64748b', '#8b5cf6'][index % 5]} />
                                                                    ))}
                                                                </Pie>
                                                                <Tooltip />
                                                            </PieChart>
                                                        </ResponsiveContainer>
                                                        <div className="flex flex-wrap justify-center gap-4 mt-2">
                                                            {dashboardStats.statusChart.map((s, i) => (
                                                                <div key={i} className="flex items-center gap-2 text-xs text-slate-600 font-medium">
                                                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#64748b', '#8b5cf6'][i % 5] }}></div>
                                                                    {s.name}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* List View */}
                                    {activeTab === 'list' && (
                                        <div className="space-y-6">
                                            <div className="flex flex-col md:flex-row gap-4 items-center justify-between">
                                                <div className="relative w-full md:w-96">
                                                    <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                                        <Icon name="search" size={18} className="text-slate-400" />
                                                    </div>
                                                    <input
                                                        type="text"
                                                        placeholder="Buscar por cidadão ou problema..."
                                                        className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none"
                                                        value={searchTerm}
                                                        onChange={(e) => setSearchTerm(e.target.value)}
                                                    />
                                                </div>
                                                <div className="flex gap-2 items-center flex-wrap md:flex-nowrap w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                                                    <button
                                                        onClick={() => handleExport('excel')}
                                                        className="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 rounded-xl text-sm font-bold border border-emerald-200 hover:bg-emerald-100 transition-all whitespace-nowrap"
                                                        title="Exportar para Excel"
                                                    >
                                                        <Icon name="file-spreadsheet" size={18} /> Excel
                                                    </button>
                                                    <button
                                                        onClick={() => handleExport('pdf')}
                                                        className="flex items-center gap-2 px-4 py-2 bg-rose-50 text-rose-700 rounded-xl text-sm font-bold border border-rose-200 hover:bg-rose-100 transition-all whitespace-nowrap"
                                                        title="Exportar para PDF"
                                                    >
                                                        <Icon name="file-text" size={18} /> PDF
                                                    </button>

                                                    <div className="w-px h-6 bg-slate-200 mx-2 hidden md:block"></div>

                                                    <button
                                                        onClick={() => setFilterBairro('Todos')}
                                                        className={`px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${filterBairro === 'Todos' ? 'bg-primary text-white' : 'bg-white border text-slate-600'}`}
                                                    >
                                                        Todos
                                                    </button>
                                                    {bairros.map(b => (
                                                        <button
                                                            key={b}
                                                            onClick={() => setFilterBairro(b)}
                                                            className={`px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${filterBairro === b ? 'bg-primary text-white' : 'bg-white border text-slate-600'}`}
                                                        >
                                                            {b}
                                                        </button>
                                                    ))}

                                                    <div className="w-px h-6 bg-slate-200 mx-2 hidden md:block"></div>

                                                    <select
                                                        value={filterStatus}
                                                        onChange={(e) => setFilterStatus(e.target.value)}
                                                        className="px-4 py-2 rounded-xl border border-slate-200 bg-white text-sm font-medium outline-none focus:ring-2 focus:ring-primary/20"
                                                    >
                                                        <option value="Todos">Status</option>
                                                        {STATUS_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                                <table className="w-full text-left border-collapse">
                                                    <thead className="bg-slate-50/80 border-b">
                                                        <tr>
                                                            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Cidadão / Bairro</th>
                                                            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Tipo / Urgência</th>
                                                            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                                                            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Data</th>
                                                            <th className="px-6 py-4"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {demandas.map(d => (
                                                            <tr key={d.id} className="hover:bg-slate-50/50 transition-all cursor-pointer" onClick={() => setSelectedDemanda(d)}>
                                                                <td className="px-6 py-5">
                                                                    <p className="font-semibold text-slate-800">{d.cidadao}</p>
                                                                    <p className="text-xs text-slate-500 flex items-center gap-1">
                                                                        <Icon name="map-pin" size={12} /> {d.bairro}
                                                                    </p>
                                                                </td>
                                                                <td className="px-6 py-5">
                                                                    <p className="text-sm font-medium text-slate-700">{d.tipo}</p>
                                                                    <Badge color={getUrgenciaColor(d.urgencia)}>{d.urgencia}</Badge>
                                                                </td>
                                                                <td className="px-6 py-5">
                                                                    <Badge color={getStatusColor(d.status)}>{d.status}</Badge>
                                                                </td>
                                                                <td className="px-6 py-5">
                                                                    <p className="text-xs text-slate-500 font-medium">{new Date(d.registro).toLocaleDateString('pt-BR')}</p>
                                                                </td>
                                                                <td className="px-6 py-5 text-right">
                                                                    <button className="text-primary hover:bg-primary/5 p-2 rounded-lg transition-all">
                                                                        <Icon name="chevron-right" size={20} />
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                        {demandas.length === 0 && (
                                                            <tr>
                                                                <td colSpan="5" className="px-6 py-20 text-center">
                                                                    <div className="flex flex-col items-center gap-3 text-slate-400">
                                                                        <Icon name="inbox" size={48} strokeWidth={1} />
                                                                        <p className="text-lg">Nenhuma demanda encontrada.</p>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>

                                            {/* Paginação */}
                                            <div className="flex items-center justify-between px-2">
                                                <p className="text-sm text-slate-500">
                                                    Mostrando <span className="font-bold">{demandas.length > 0 ? page * PAGE_SIZE + 1 : 0}</span> a <span className="font-bold">{Math.min((page + 1) * PAGE_SIZE, totalCount)}</span> de <span className="font-bold">{totalCount}</span> resultados
                                                </p>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => setPage(p => Math.max(0, p - 1))}
                                                        disabled={page === 0}
                                                        className="px-4 py-2 border border-slate-200 rounded-xl text-sm font-medium hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        Anterior
                                                    </button>
                                                    <button
                                                        onClick={() => setPage(p => (p + 1) * PAGE_SIZE < totalCount ? p + 1 : p)}
                                                        disabled={(page + 1) * PAGE_SIZE >= totalCount}
                                                        className="px-4 py-2 border border-slate-200 rounded-xl text-sm font-medium hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        Próxima
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Registration Form View */}
                                    {activeTab === 'add' && (
                                        <div className="max-w-2xl mx-auto">
                                            <div className="glass p-8 rounded-2xl bg-white/30 border-t-4 border-t-primary">
                                                <h3 className="text-xl font-bold mb-8 flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center">
                                                        <Icon name="plus" />
                                                    </div>
                                                    Nova Solicitação de Cidadão
                                                </h3>
                                                <form onSubmit={handleAddDemanda} className="space-y-6">
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                        <div className="space-y-2">
                                                            <label className="text-sm font-bold text-slate-700">Nome do Cidadão</label>
                                                            <input required name="cidadao" className="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="Ex: Maria José" />
                                                        </div>
                                                        <div className="space-y-2">
                                                            <label className="text-sm font-bold text-slate-700">Bairro</label>
                                                            <select name="bairro" className="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                                                {bairros.map(b => <option key={b} value={b}>{b}</option>)}
                                                            </select>
                                                        </div>
                                                        <div className="space-y-2 md:col-span-2">
                                                            <label className="text-sm font-bold text-slate-700">Endereço Completo</label>
                                                            <input required name="endereco" className="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="Rua, Número, Complemento..." />
                                                        </div>
                                                        <div className="space-y-2">
                                                            <label className="text-sm font-bold text-slate-700">Tipo de Demanda</label>
                                                            <select name="tipo" className="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                                                {TIPOS_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}
                                                            </select>
                                                        </div>
                                                        <div className="space-y-2">
                                                            <label className="text-sm font-bold text-slate-700">Urgência</label>
                                                            <select name="urgencia" className="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                                                <option value="Baixa">Baixa</option>
                                                                <option value="Média">Média</option>
                                                                <option value="Alta">Alta</option>
                                                                <option value="Crítica">Crítica</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-2">
                                                        <label className="text-sm font-bold text-slate-700">Descrição Detalhada</label>
                                                        <textarea required name="descricao" rows="4" className="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="Descreva os detalhes da solicitação..."></textarea>
                                                    </div>
                                                    <button type="submit" className="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.01] active:scale-95 transition-all">
                                                        Salvar Registro
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    )}
                                    {/* Password Reset View */}
                                    {activeTab === 'password' && (
                                        <div className="max-w-md mx-auto">
                                            <div className="glass p-8 rounded-2xl bg-white/30 border-t-4 border-t-primary">
                                                <h3 className="text-xl font-bold mb-8 flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center">
                                                        <Icon name="key" />
                                                    </div>
                                                    Alterar Minha Senha
                                                </h3>
                                                <form onSubmit={handleUpdatePassword} className="space-y-6">
                                                    <div className="space-y-2">
                                                        <label className="text-sm font-bold text-slate-700">Nova Senha</label>
                                                        <input required name="password" type="password" minLength="6" className="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="••••••••" />
                                                    </div>
                                                    <div className="space-y-2">
                                                        <label className="text-sm font-bold text-slate-700">Confirmar Nova Senha</label>
                                                        <input required name="confirmPassword" type="password" minLength="6" className="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="••••••••" />
                                                    </div>
                                                    <button disabled={loading} className="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.01] active:scale-95 transition-all">
                                                        {loading ? 'Salvando...' : 'Atualizar Senha'}
                                                    </button>
                                                </form>
                                                <p className="mt-6 text-center text-xs text-slate-400">
                                                    Sua senha será atualizada imediatamente para o próximo acesso.
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </main >

                    {/* Details Modal */}
                    {
                        selectedDemanda && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                                <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={() => setSelectedDemanda(null)}></div>
                                <div className="glass bg-white max-w-lg w-full rounded-3xl p-8 relative shadow-2xl animate-in zoom-in duration-200">
                                    <div className="flex justify-between items-start mb-6">
                                        <div>
                                            <Badge color={getUrgenciaColor(selectedDemanda.urgencia)}>{selectedDemanda.urgencia}</Badge>
                                            <h3 className="text-2xl font-bold text-slate-800 mt-2">{selectedDemanda.tipo}</h3>
                                            <p className="text-slate-500 font-medium">Protocolo: #{selectedDemanda.id}</p>
                                        </div>
                                        <button onClick={() => setSelectedDemanda(null)} className="p-2 hover:bg-slate-100 rounded-full transition-all">
                                            <Icon name="x" />
                                        </button>
                                    </div>

                                    <div className="space-y-6">
                                        {selectedDemanda.deleted_at && selectedDemanda.motivo_exclusao && (
                                            <div className="p-4 bg-red-50 rounded-2xl border border-red-100">
                                                <p className="text-[10px] font-black uppercase tracking-widest text-red-400 mb-1">Motivo da Exclusão / Cancelamento</p>
                                                <p className="text-sm text-red-700 font-bold">{selectedDemanda.motivo_exclusao}</p>
                                                <p className="text-[10px] text-red-400 mt-2 italic">Excluído em: {new Date(selectedDemanda.deleted_at).toLocaleString('pt-BR')}</p>
                                            </div>
                                        )}
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="p-4 rounded-2xl bg-slate-50">
                                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Cidadão</p>
                                                <p className="font-semibold text-slate-700">{selectedDemanda.cidadao}</p>
                                            </div>
                                            <div className="p-4 rounded-2xl bg-slate-50">
                                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Bairro</p>
                                                <p className="font-semibold text-slate-700">{selectedDemanda.bairro}</p>
                                            </div>
                                        </div>

                                        <div className="p-4 rounded-2xl bg-slate-50">
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Endereço</p>
                                            <p className="font-semibold text-slate-700">{selectedDemanda.endereco || 'Não informado'}</p>
                                        </div>

                                        <div>
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Relato</p>
                                            <p className="text-slate-700 leading-relaxed bg-slate-50 p-4 rounded-2xl italic border-l-4 border-primary">
                                                "{selectedDemanda.descricao}"
                                            </p>
                                        </div>

                                        <div>
                                            <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Alterar Status</p>
                                            <div className="grid grid-cols-2 gap-2">
                                                {STATUS_OPTIONS.map(s => (
                                                    <button
                                                        key={s}
                                                        onClick={() => updateStatus(selectedDemanda.id, s)}
                                                        className={`px-3 py-2 rounded-xl text-xs font-semibold transition-all border ${selectedDemanda.status === s
                                                            ? 'bg-primary border-primary text-white'
                                                            : 'bg-white border-slate-200 text-slate-600 hover:border-primary/50'
                                                            }`}
                                                    >
                                                        {s}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-end pt-4 border-t border-slate-100 mt-6">
                                        <button
                                            onClick={() => deleteDemanda(selectedDemanda.id)}
                                            className="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-xl transition-all font-medium text-sm"
                                        >
                                            <Icon name="trash-2" size={16} /> Excluir Registro
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

        const rootEl = document.getElementById('root');
        if (rootEl) {
            const root = window.ReactDOM.createRoot(rootEl);
            root.render(<App />);
            console.log("App rendered successfully");
        } else {
            console.error("Root element not found");
        }
    </script>

</body>

</html>